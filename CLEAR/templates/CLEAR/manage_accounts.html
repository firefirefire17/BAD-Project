{% extends "CLEAR/base.html" %}
{% load static %}

<head>
    <link rel="stylesheet" href="{% static '/stylesheet3.css' %}">
</head>

{% block search %}
<img class="searchnav" src="https://i.imgur.com/04qNE39.png">
<form id="search-form" method="GET" action="{% url 'filter_materials' %}">
    {% csrf_token %}
    <input id="search-input" class="search" name="q" type="search" placeholder="Search..."
        style="background-color: transparent; border:none; height: 40px; margin-top: 8px; width: max-content; color: white;">
</form>
{% endblock %}

{% block content %}
<div class="row pl-3 pt-3 pr-3" style="height:700px;">
    <div class="card main-card">

            <div class="table-responsive card"
                style="overflow-y: scroll; border-radius: 15px; box-shadow: none; height: 90%; margin-bottom: 13px;">
                <table id="accountTable" class="table table-hover table-striped" style="border-radius: 40px;">
                    <thead class="sticky-top" style="background-color: #3f3e3e; color: #ffffff;">
                        <tr>
                            <th>Username</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Role</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in account_objects %}
                        <tr>
                            <td>{{ account.user.username }}</td>
                            <td>{{ account.user.first_name }}</td>
                            <td>{{ account.user.last_name }}</td>
                            <td>{{ account.role }}</td>
                            <td>
                                {% if account.user == request.user %}
                                <button type="button" class="btn btn-danger" disabled>Delete</button>
                                {% else %}
                                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delconf-modal{{ account.user.pk }}">
                                    Delete
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>

    </div>
</div>

{% for account in account_objects %} 
<!-- Modal for delete confirmation -->
<div class="modal" id="delconf-modal{{ account.user.pk }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
            </div>
            <div class="modal-footer">
                <form method="POST" action="{% url 'delete_user' account.user.pk %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% if user.is_authenticated %}
    <script>
        var currentUserID = '{{ user.pk }}';
    </script>
{% endif %}
<script>
    $(document).ready(function () {
        $('#search-form').on('input submit', function(event) {
            event.preventDefault();
            var query = $('#search-input').val();

            $.ajax({
                url: '/search_users/',
                type: 'GET',
                data: {
                    'q': query
                },
                success: function(response) {
                    console.log("AJAX request successful.");
                    updateTable(response.table_data);
                },
                error: function(error) {
                    console.error("AJAX request failed:", error);
                }
            });
        });
    });

function updateTable(data) {
    $('#accountTable tbody').empty();

    $.each(data, function(index, item) {
        var row = $('<tr>');

        var usernameCell = $('<td>').text(item.username);
        var firstNameCell = $('<td>').text(item.first_name);
        var lastNameCell = $('<td>').text(item.last_name);
        var roleCell = $('<td>').text(item.role);
        var actionsCell = $('<td>');

        var deleteButton = $('<button>').addClass('btn btn-danger').text('Delete');
        if (item.user_pk == currentUserID) {
            deleteButton.prop('disabled', true);
        } else {
            deleteButton.attr('data-toggle', 'modal').attr('data-target', '#delconf-modal' + item.user_pk);

        }

        actionsCell.append(deleteButton);

        row.append(usernameCell);
        row.append(firstNameCell);
        row.append(lastNameCell);
        row.append(roleCell);
        row.append(actionsCell);

        $('#accountTable tbody').append(row);
        console.log('item.user_pk:', item.user_pk);
        console.log('currentUserID:', currentUserID);
    });
}




</script>

{% endblock %}